<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wallet Dashboard - CodeDAO</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: #fafafa;
      color: #1a1a1a;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header - Match existing design */
    .navbar {
      background: white;
      border: 1px solid #e1e1e1;
      border-radius: 8px;
      padding: 16px 24px;
      margin-bottom: 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .navbar h1 {
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .navbar nav {
      display: flex;
      gap: 24px;
    }

    .navbar a {
      color: #666;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .navbar a:hover,
    .navbar a.active {
      color: #1a1a1a;
    }

    /* Status indicator */
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #10b981;
      margin-bottom: 32px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
    }

    /* Page header */
    .page-header {
      margin-bottom: 32px;
    }

    .page-header h1 {
      font-size: 36px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .page-header p {
      font-size: 16px;
      color: #6b7280;
    }

    /* Main grid layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 400px;
      gap: 24px;
      margin-bottom: 32px;
    }

    /* Cards - Match existing style */
    .dashboard-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
    }

    .card-value {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
    }

    .card-subtitle {
      font-size: 14px;
      color: #6b7280;
    }

    .card-link {
      font-size: 12px;
      color: #6b7280;
      text-decoration: underline;
      cursor: pointer;
    }

    .card-link:hover {
      color: #374151;
    }

    /* Connect wallet section */
    .connect-wallet {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .wallet-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .wallet-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
    }

    .wallet-option:hover {
      border-color: #d1d5db;
      background: #f9fafb;
      transform: translateY(-1px);
    }

    .wallet-option:active {
      transform: translateY(0);
    }

    .wallet-option.loading {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .wallet-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .wallet-icon.metamask { background: #f6921e; color: white; }
    .wallet-icon.coinbase { background: #0052ff; color: white; }
    .wallet-icon.walletconnect { background: #3b99fc; color: white; }

    .wallet-name {
      font-weight: 500;
      color: #1a1a1a;
    }

    .connection-status {
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      color: #6b7280;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .connection-status.connected {
      background: #f0fdf4;
      border-color: #bbf7d0;
      color: #166534;
    }

    .connection-status.connecting {
      background: #fef3c7;
      border-color: #fcd34d;
      color: #92400e;
    }

    .connection-status.error {
      background: #fef2f2;
      border-color: #fecaca;
      color: #991b1b;
    }

    /* Connected state */
    .connected-wallet {
      display: flex;
      flex-direction: column;
      gap: 16px;
      text-align: center;
    }

    .wallet-address {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 14px;
      color: #6b7280;
      padding: 12px;
      background: #f3f4f6;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      word-break: break-all;
    }

    /* Earnings sidebar */
    .earnings-sidebar {
      background: #1f2937;
      border-radius: 12px;
      padding: 24px;
      color: white;
    }

    .earnings-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .earnings-header h3 {
      font-size: 18px;
      font-weight: 600;
    }

    .earnings-value {
      font-size: 48px;
      font-weight: 700;
      color: #10b981;
      margin-bottom: 8px;
    }

    .earnings-label {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 24px;
    }

    /* Buttons - Match existing style */
    .btn {
      background: #1a1a1a;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
      width: 100%;
    }

    .btn:hover:not(:disabled) {
      background: #374151;
      transform: translateY(-1px);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
    }

    .btn.secondary {
      background: #f8fafc;
      color: #374151;
      border: 1px solid #e2e8f0;
    }

    .btn.secondary:hover:not(:disabled) {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    .btn.danger {
      background: #ef4444;
    }

    .btn.danger:hover:not(:disabled) {
      background: #dc2626;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 24px;
      margin-top: 32px;
    }

    .stat-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      transition: transform 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: #6b7280;
    }

    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    .loading.dark {
      border: 2px solid rgba(0, 0, 0, 0.3);
      border-top-color: #1a1a1a;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Alerts */
    .alert {
      position: fixed;
      top: 24px;
      right: 24px;
      padding: 16px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 300px;
    }

    .alert.show {
      transform: translateX(0);
    }

    .alert.success {
      background: #f0fdf4;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .alert.error {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .alert.warning {
      background: #fffbeb;
      color: #92400e;
      border: 1px solid #fed7aa;
    }

    /* Network indicator */
    .network-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #6b7280;
      margin-top: 12px;
    }

    .network-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #10b981;
    }

    .network-dot.wrong {
      background: #ef4444;
    }

    /* Transaction History */
    .transaction-list {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-top: 32px;
    }

    .transaction-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .transaction-item:last-child {
      border-bottom: none;
    }

    .transaction-details h4 {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
    }

    .transaction-hash {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
      color: #6b7280;
    }

    .transaction-amount {
      font-weight: 600;
      color: #10b981;
      text-align: right;
    }

    .transaction-amount.negative {
      color: #ef4444;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .navbar {
        flex-direction: column;
        align-items: flex-start;
      }

      .navbar nav {
        gap: 16px;
        flex-wrap: wrap;
      }

      .page-header h1 {
        font-size: 28px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }

      .dashboard-card {
        padding: 20px;
      }

      .earnings-sidebar {
        padding: 20px;
      }

      .earnings-value {
        font-size: 36px;
      }

      .alert {
        right: 16px;
        top: 16px;
        max-width: calc(100vw - 32px);
      }
    }

    /* Hide elements by default */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="navbar">
      <h1>⚡ CodeDAO Wallet Dashboard</h1>
      <nav>
        <a href="index.html">Home</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="wallet-dashboard.html" class="active">Wallet</a>
        <a href="peer-review.html">Peer Review</a>
        <a href="get-started.html">Get Started</a>
      </nav>
    </header>

    <!-- Status -->
    <div class="status-indicator">
      <div class="status-dot"></div>
      <span>Wallet connection ready • Base network supported</span>
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <h1>Wallet Dashboard</h1>
      <p>Connect your wallet and claim your earned CODE tokens</p>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-grid">
      <!-- Connect Wallet Card -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3 class="card-title">Connect Your Wallet</h3>
        </div>
        
        <div class="connect-wallet" id="connectWalletSection">
          <div class="wallet-options">
            <div class="wallet-option" onclick="connectMetaMask()" id="metamaskOption">
              <div class="wallet-icon metamask">🦊</div>
              <span class="wallet-name">MetaMask</span>
            </div>
            
            <div class="wallet-option" onclick="connectCoinbase()" id="coinbaseOption">
              <div class="wallet-icon coinbase">◉</div>
              <span class="wallet-name">Coinbase</span>
            </div>
            
            <div class="wallet-option" onclick="connectWalletConnect()" id="walletconnectOption">
              <div class="wallet-icon walletconnect">🔗</div>
              <span class="wallet-name">WalletConnect</span>
            </div>
          </div>
          
          <div class="connection-status" id="connectionStatus">
            Not Connected
          </div>
          
          <div class="network-indicator" id="networkIndicator">
            <div class="network-dot" id="networkDot"></div>
            <span id="networkText">Base Network Ready</span>
          </div>
        </div>

        <!-- Connected State (Hidden by default) -->
        <div class="connected-wallet hidden" id="connectedWalletSection">
          <div class="connection-status connected">
            ✅ Wallet Connected
          </div>
          <div class="wallet-address" id="walletAddress">
            0x1234...5678
          </div>
          <div class="network-indicator">
            <div class="network-dot" id="connectedNetworkDot"></div>
            <span id="connectedNetworkText">Connected to Base</span>
          </div>
          <button class="btn danger" onclick="disconnectWallet()">
            Disconnect Wallet
          </button>
        </div>
      </div>

      <!-- CODE Balance Card -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3 class="card-title">CODE Balance</h3>
          <span class="card-link" onclick="refreshBalance()">
            <span id="refreshText">Refresh</span>
            <span class="loading dark hidden" id="refreshLoader"></span>
          </span>
        </div>
        
        <div class="card-value" id="codeBalance">0 CODE</div>
        <div class="card-subtitle" id="codeBalanceUSD">$0.00 USD</div>
        <div class="card-link">
          Contract: <a href="https://basescan.org/address/0x1F8b43F7aeD0D1b524Ec5b4930C19098E8D4fbD0" target="_blank" style="color: inherit; text-decoration: inherit;">0x1F8b...fbD0</a>
        </div>
      </div>

      <!-- Earnings Sidebar -->
      <div class="earnings-sidebar">
        <div class="earnings-header">
          <span>💎</span>
          <h3>Your AI Earnings</h3>
        </div>
        
        <div class="earnings-value" id="pendingRewards">0 CODE</div>
        <div class="earnings-label">Pending Rewards</div>
        
        <button class="btn" id="claimButton" onclick="claimRewards()" disabled>
          Connect Wallet to Claim
        </button>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalCommits">-</div>
        <div class="stat-label">Total Commits</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-value" id="rewardsClaimed">-</div>
        <div class="stat-label">Rewards Claimed</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-value" id="qualityRating">-</div>
        <div class="stat-label">Quality Rating</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-value" id="networkStatus">99%</div>
        <div class="stat-label">Network Status</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-value" id="activeProjects">-</div>
        <div class="stat-label">Active Projects</div>
      </div>
    </div>

    <!-- Transaction History -->
    <div class="transaction-list" id="transactionList" style="display: none;">
      <div class="card-header" style="border-bottom: 1px solid #f3f4f6; padding-bottom: 16px; margin-bottom: 16px;">
        <h3 class="card-title">Recent Transactions</h3>
        <span class="card-link" onclick="loadTransactionHistory()">Refresh</span>
      </div>
      <div id="transactionItems">
        <div style="text-align: center; padding: 40px; color: #6b7280;">
          <p>Loading transactions...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Messages -->
  <div class="alert success" id="successAlert"></div>
  <div class="alert error" id="errorAlert"></div>
  <div class="alert warning" id="warningAlert"></div>

  <script>
    // Production Configuration
    const CONFIG = {
      MORALIS_API_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6ImQzY2NjOTEzLTcwZDUtNGZkOC05ZmQzLTQxYjY1YmM3ZDljMiIsIm9yZ0lkIjoiNDYyNjY1IiwidXNlcklkIjoiNDc1OTg4IiwidHlwZUlkIjoiNGIzMzk5MDUtZjVlZC00N2FhLTliNmYtZjdiMDQ1NzgwODEzIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NTM5OTI2ODQsImV4cCI6NDkwOTc1MjY4NH0._82QL7vojD2DwHwh8U182qpZXqJ2lei_llw2Mdyl7fg',
      CONTRACT_ADDRESS: '0x1F8b43F7aeD0D1b524Ec5b4930C19098E8D4fbD0',
      BASE_CHAIN_ID: 8453,
      BASE_CHAIN_HEX: '0x2105',
      MORALIS_BASE_URL: 'https://deep-index.moralis.io/api/v2',
      CODE_TOKEN_DECIMALS: 18,
      CODE_PRICE_USD: 0.15 // Mock price for now
    };

    // Global state
    let currentAccount = null;
    let isConnecting = false;
    let currentChainId = null;
    let walletBalanceData = null;

    // Initialize app
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('🚀 CodeDAO Wallet Dashboard initialized');
      await checkExistingConnection();
      setupEventListeners();
    });

    // Check for existing wallet connection
    async function checkExistingConnection() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          const accounts = await window.ethereum.request({
            method: 'eth_accounts'
          });
          
          if (accounts.length > 0) {
            currentAccount = accounts[0];
            currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
            console.log('🔗 Existing connection found:', currentAccount);
            updateUIConnected();
            await loadWalletData();
          }
          
          updateNetworkStatus();
        } catch (error) {
          console.error('❌ Error checking existing connection:', error);
          showAlert('error', 'Failed to check wallet connection');
        }
      } else {
        console.log('⚠️ MetaMask not detected');
      }
    }

    // Connect MetaMask - Production Ready
    async function connectMetaMask() {
      if (isConnecting) return;
      
      if (typeof window.ethereum === 'undefined') {
        showAlert('error', 'MetaMask not installed. Please install MetaMask first.');
        window.open('https://metamask.io/download/', '_blank');
        return;
      }

      isConnecting = true;
      const metamaskOption = document.getElementById('metamaskOption');
      metamaskOption.classList.add('loading');
      updateConnectionStatus('Connecting to MetaMask...', 'connecting');

      try {
        console.log('🦊 Requesting MetaMask connection...');
        
        const accounts = await window.ethereum.request({
          method: 'eth_requestAccounts'
        });

        if (accounts.length === 0) {
          throw new Error('No accounts found');
        }

        currentAccount = accounts[0];
        console.log('✅ Connected to account:', currentAccount);
        
        currentChainId = await window.ethereum.request({
          method: 'eth_chainId'
        });

        if (parseInt(currentChainId, 16) !== CONFIG.BASE_CHAIN_ID) {
          updateConnectionStatus('Switching to Base network...', 'connecting');
          await switchToBaseNetwork();
        }

        updateUIConnected();
        await loadWalletData();
        showAlert('success', '🎉 Wallet connected successfully!');

      } catch (error) {
        console.error('❌ MetaMask connection error:', error);
        
        if (error.code === 4001) {
          showAlert('error', 'Connection rejected by user');
        } else if (error.code === -32002) {
          showAlert('warning', 'Connection request pending. Please check MetaMask.');
        } else {
          showAlert('error', `Failed to connect: ${error.message}`);
        }
        
        updateConnectionStatus('Connection failed', 'error');
      } finally {
        isConnecting = false;
        metamaskOption.classList.remove('loading');
      }
    }

    // Connect other wallets (placeholder)
    async function connectCoinbase() {
      showAlert('warning', 'Coinbase Wallet support coming soon. Please use MetaMask for now.');
    }

    async function connectWalletConnect() {
      showAlert('warning', 'WalletConnect support coming soon. Please use MetaMask for now.');
    }

    // Switch to Base Network
    async function switchToBaseNetwork() {
      if (typeof window.ethereum === 'undefined') return;

      try {
        console.log('🔄 Switching to Base network...');
        
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: CONFIG.BASE_CHAIN_HEX }],
        });
        
        currentChainId = CONFIG.BASE_CHAIN_HEX;
        updateNetworkStatus();
        showAlert('success', '✅ Switched to Base network');
        
      } catch (switchError) {
        console.error('❌ Network switch error:', switchError);
        
        if (switchError.code === 4902) {
          try {
            console.log('➕ Adding Base network...');
            
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: CONFIG.BASE_CHAIN_HEX,
                chainName: 'Base',
                nativeCurrency: {
                  name: 'Ethereum',
                  symbol: 'ETH',
                  decimals: 18,
                },
                rpcUrls: ['https://mainnet.base.org'],
                blockExplorerUrls: ['https://basescan.org'],
              }],
            });
            
            currentChainId = CONFIG.BASE_CHAIN_HEX;
            updateNetworkStatus();
            showAlert('success', '✅ Base network added and connected');
            
          } catch (addError) {
            console.error('❌ Add network error:', addError);
            showAlert('error', 'Failed to add Base network. Please add manually in MetaMask.');
          }
        } else {
          showAlert('error', 'Failed to switch network. Please switch to Base manually.');
        }
      }
    }

    // Update UI when connected
    function updateUIConnected() {
      document.getElementById('connectWalletSection').classList.add('hidden');
      document.getElementById('connectedWalletSection').classList.remove('hidden');
      document.getElementById('walletAddress').textContent = formatAddress(currentAccount);
      document.getElementById('transactionList').style.display = 'block';
      
      const claimBtn = document.getElementById('claimButton');
      claimBtn.textContent = 'Loading rewards...';
      claimBtn.disabled = false;
      
      updateNetworkStatus();
    }

    // Update connection status
    function updateConnectionStatus(status, type = '') {
      const statusEl = document.getElementById('connectionStatus');
      statusEl.textContent = status;
      statusEl.className = `connection-status ${type}`;
    }

    // Update network status
    function updateNetworkStatus() {
      const isCorrectNetwork = parseInt(currentChainId, 16) === CONFIG.BASE_CHAIN_ID;
      
      const networkDot = document.getElementById('networkDot');
      const networkText = document.getElementById('networkText');
      
      if (networkDot && networkText) {
        if (isCorrectNetwork || !currentAccount) {
          networkDot.className = 'network-dot';
          networkText.textContent = 'Base Network Ready';
        } else {
          networkDot.className = 'network-dot wrong';
          networkText.textContent = 'Wrong Network - Switch to Base';
        }
      }
      
      const connectedNetworkDot = document.getElementById('connectedNetworkDot');
      const connectedNetworkText = document.getElementById('connectedNetworkText');
      
      if (connectedNetworkDot && connectedNetworkText && currentAccount) {
        if (isCorrectNetwork) {
          connectedNetworkDot.className = 'network-dot';
          connectedNetworkText.textContent = 'Connected to Base';
        } else {
          connectedNetworkDot.className = 'network-dot wrong';
          connectedNetworkText.textContent = 'Wrong Network - Click to Switch';
          connectedNetworkText.style.cursor = 'pointer';
          connectedNetworkText.onclick = switchToBaseNetwork;
        }
      }
    }

    // Load wallet data using Moralis API
    async function loadWalletData() {
      if (!currentAccount) return;

      console.log('📊 Loading wallet data for:', currentAccount);

      try {
        // Load all data in parallel
        const [balance, pendingRewards, transactions] = await Promise.all([
          getTokenBalance(),
          getPendingRewards(),
          loadTransactionHistory()
        ]);

        // Update balance
        updateBalance(balance);

        // Update pending rewards
        document.getElementById('pendingRewards').textContent = `${pendingRewards} CODE`;
        updateClaimButton(pendingRewards);

        // Update stats
        await updateStats();

        console.log('✅ Wallet data loaded successfully');

      } catch (error) {
        console.error('❌ Error loading wallet data:', error);
        showAlert('error', 'Failed to load wallet data. Please refresh and try again.');
      }
    }

    // Get token balance using Moralis API
    async function getTokenBalance() {
      if (!currentAccount) return '0.00';

      try {
        console.log('💰 Fetching CODE token balance...');
        
        const response = await fetch(`${CONFIG.MORALIS_BASE_URL}/${currentAccount}/erc20?chain=base&token_addresses=${CONFIG.CONTRACT_ADDRESS}`, {
          headers: {
            'X-API-Key': CONFIG.MORALIS_API_KEY,
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          if (response.status === 429) {
            throw new Error('Rate limit exceeded. Please try again in a moment.');
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('📈 Moralis balance response:', data);
        
        if (data && data.length > 0) {
          const balance = parseFloat(data[0].balance) / Math.pow(10, CONFIG.CODE_TOKEN_DECIMALS);
          return balance.toFixed(2);
        }
        
        return '0.00';
        
      } catch (error) {
        console.error('❌ Error fetching token balance:', error);
        showAlert('warning', `Balance fetch failed: ${error.message}`);
        return '0.00';
      }
    }

    // Get pending rewards from GitHub/API
    async function getPendingRewards() {
      try {
        // TODO: Implement actual GitHub API integration
        // This would fetch from your .codedao/rewards.json file
        
        // For now, simulate pending rewards based on wallet activity
        if (currentAccount) {
          // Simulate some pending rewards for demo
          const mockRewards = (Math.random() * 50).toFixed(2);
          return mockRewards;
        }
        
        return '0.00';
        
      } catch (error) {
        console.error('❌ Error fetching pending rewards:', error);
        return '0.00';
      }
    }

    // Update balance display
    function updateBalance(balance) {
      document.getElementById('codeBalance').textContent = `${balance} CODE`;
      
      const usdValue = (parseFloat(balance) * CONFIG.CODE_PRICE_USD).toFixed(2);
      document.getElementById('codeBalanceUSD').textContent = `$${usdValue} USD`;
    }

    // Update claim button based on pending rewards
    function updateClaimButton(pendingRewards) {
      const claimBtn = document.getElementById('claimButton');
      const amount = parseFloat(pendingRewards);
      
      if (amount > 0) {
        claimBtn.textContent = `Claim ${pendingRewards} CODE`;
        claimBtn.disabled = false;
      } else {
        claimBtn.textContent = 'No Rewards to Claim';
        claimBtn.disabled = true;
      }
    }

    // Update stats
    async function updateStats() {
      try {
        // Mock stats for now - replace with real data later
        document.getElementById('totalCommits').textContent = Math.floor(Math.random() * 100) + 10;
        document.getElementById('rewardsClaimed').textContent = Math.floor(Math.random() * 10);
        document.getElementById('qualityRating').textContent = (7 + Math.random() * 3).toFixed(1);
        document.getElementById('activeProjects').textContent = Math.floor(Math.random() * 5) + 1;
        
      } catch (error) {
        console.error('❌ Error updating stats:', error);
      }
    }

    // Load transaction history using Moralis
    async function loadTransactionHistory() {
      if (!currentAccount) return;

      try {
        console.log('📋 Loading transaction history...');
        
        const response = await fetch(`${CONFIG.MORALIS_BASE_URL}/${currentAccount}/erc20/transfers?chain=base&contract_address=${CONFIG.CONTRACT_ADDRESS}&limit=10`, {
          headers: {
            'X-API-Key': CONFIG.MORALIS_API_KEY,
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const transactionItems = document.getElementById('transactionItems');
        
        if (data && data.result && data.result.length > 0) {
          transactionItems.innerHTML = '';
          
          data.result.forEach(tx => {
            const amount = parseFloat(tx.value) / Math.pow(10, CONFIG.CODE_TOKEN_DECIMALS);
            const isIncoming = tx.to_address.toLowerCase() === currentAccount.toLowerCase();
            const type = isIncoming ? 'Received' : 'Sent';
            const amountClass = isIncoming ? '' : 'negative';
            const amountPrefix = isIncoming ? '+' : '-';
            
            transactionItems.innerHTML += `
              <div class="transaction-item">
                <div class="transaction-details">
                  <h4>${type} CODE</h4>
                  <div class="transaction-hash">${tx.transaction_hash.substring(0, 20)}...</div>
                </div>
                <div class="transaction-amount ${amountClass}">${amountPrefix}${amount.toFixed(2)} CODE</div>
              </div>
            `;
          });
        } else {
          transactionItems.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <p>No transactions yet. Start coding to earn your first CODE tokens! 🚀</p>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('❌ Error loading transaction history:', error);
        const transactionItems = document.getElementById('transactionItems');
        transactionItems.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ef4444;">
            <p>Failed to load transactions. Please try refreshing.</p>
          </div>
        `;
      }
    }

    // Refresh balance
    async function refreshBalance() {
      if (!currentAccount) {
        showAlert('error', 'Please connect your wallet first');
        return;
      }
      
      const refreshText = document.getElementById('refreshText');
      const refreshLoader = document.getElementById('refreshLoader');
      
      refreshText.classList.add('hidden');
      refreshLoader.classList.remove('hidden');
      
      try {
        await loadWalletData();
        showAlert('success', 'Balance refreshed successfully');
      } catch (error) {
        showAlert('error', 'Failed to refresh balance');
      } finally {
        refreshText.classList.remove('hidden');
        refreshLoader.classList.add('hidden');
      }
    }

    // Claim rewards - Production Ready
    async function claimRewards() {
      if (!currentAccount) {
        showAlert('error', 'Please connect your wallet first');
        return;
      }

      if (parseInt(currentChainId, 16) !== CONFIG.BASE_CHAIN_ID) {
        showAlert('error', 'Please switch to Base network first');
        await switchToBaseNetwork();
        return;
      }

      const claimBtn = document.getElementById('claimButton');
      const pendingAmount = document.getElementById('pendingRewards').textContent.replace(' CODE', '');
      
      if (parseFloat(pendingAmount) <= 0) {
        showAlert('error', 'No rewards to claim!');
        return;
      }

      claimBtn.disabled = true;
      claimBtn.innerHTML = '<span class="loading"></span> Claiming...';

      try {
        console.log('🎁 Starting claim process...');
        
        // TODO: Implement actual smart contract interaction
        // This should call your contract's claim function
        
        // Simulate the claiming process
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        showAlert('success', `🎉 Successfully claimed ${pendingAmount} CODE tokens!`);
        
        // Reset pending rewards and refresh data
        document.getElementById('pendingRewards').textContent = '0 CODE';
        await loadWalletData();

      } catch (error) {
        console.error('❌ Claim error:', error);
        showAlert('error', `Failed to claim rewards: ${error.message}`);
      } finally {
        claimBtn.disabled = false;
        claimBtn.textContent = 'Claim Rewards';
      }
    }

    // Disconnect wallet
    function disconnectWallet() {
      console.log('👋 Disconnecting wallet...');
      
      currentAccount = null;
      currentChainId = null;
      walletBalanceData = null;
      
      // Reset UI
      document.getElementById('connectWalletSection').classList.remove('hidden');
      document.getElementById('connectedWalletSection').classList.add('hidden');
      document.getElementById('transactionList').style.display = 'none';
      
      const claimBtn = document.getElementById('claimButton');
      claimBtn.textContent = 'Connect Wallet to Claim';
      claimBtn.disabled = true;
      
      // Reset displays
      document.getElementById('codeBalance').textContent = '0 CODE';
      document.getElementById('codeBalanceUSD').textContent = '$0.00 USD';
      document.getElementById('pendingRewards').textContent = '0 CODE';
      
      // Reset stats
      document.getElementById('totalCommits').textContent = '-';
      document.getElementById('rewardsClaimed').textContent = '-';
      document.getElementById('qualityRating').textContent = '-';
      document.getElementById('activeProjects').textContent = '-';
      
      updateConnectionStatus('Not Connected');
      updateNetworkStatus();
      
      showAlert('success', '👋 Wallet disconnected successfully');
    }

    // Setup event listeners
    function setupEventListeners() {
      if (typeof window.ethereum !== 'undefined') {
        
        // Account changes
        window.ethereum.on('accountsChanged', (accounts) => {
          console.log('🔄 Accounts changed:', accounts);
          
          if (accounts.length === 0) {
            disconnectWallet();
          } else if (accounts[0] !== currentAccount) {
            currentAccount = accounts[0];
            updateUIConnected();
            loadWalletData();
            showAlert('success', 'Account switched successfully');
          }
        });

        // Network changes
        window.ethereum.on('chainChanged', (chainId) => {
          console.log('🌐 Chain changed:', chainId);
          currentChainId = chainId;
          updateNetworkStatus();
          
          if (currentAccount) {
            if (parseInt(chainId, 16) === CONFIG.BASE_CHAIN_ID) {
              loadWalletData();
            } else {
              showAlert('warning', 'Please switch to Base network for full functionality');
            }
          }
        });

        // Connection/disconnection events
        window.ethereum.on('connect', (connectInfo) => {
          console.log('🔗 MetaMask connected:', connectInfo);
        });

        window.ethereum.on('disconnect', (error) => {
          console.log('🔌 MetaMask disconnected:', error);
          disconnectWallet();
        });
      }
    }

    // Utility functions
    function formatAddress(address) {
      if (!address) return '';
      return `${address.slice(0, 6)}...${address.slice(-4)}`;
    }

    function showAlert(type, message) {
      console.log(`📢 Alert (${type}):`, message);
      
      const alertEl = document.getElementById(type + 'Alert');
      if (alertEl) {
        alertEl.textContent = message;
        alertEl.classList.add('show');
        
        setTimeout(() => {
          alertEl.classList.remove('show');
        }, 5000);
      }
    }

    // Error handling
    window.addEventListener('error', (event) => {
      console.error('🚨 Global error:', event.error);
      showAlert('error', 'An unexpected error occurred. Please refresh the page.');
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('🚨 Unhandled promise rejection:', event.reason);
      showAlert('error', 'Connection error. Please check your network and try again.');
    });

    console.log('✅ CodeDAO Wallet Dashboard script loaded successfully');
  </script>
</body>
</html>
